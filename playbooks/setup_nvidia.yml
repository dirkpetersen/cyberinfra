---
# Ansible Playbook: NVIDIA HPC/AI Infrastructure Setup
#
# Purpose: Configure NVIDIA GPU compute nodes with drivers, CUDA, and networking
#
# Usage:
#   ansible-playbook -i inventory/ssm_plugin.py playbooks/setup_nvidia.yml
#
# This playbook demonstrates the Hybrid Cloud IaC pattern:
# - Code stored in public GitHub (this file)
# - Configuration data retrieved from AWS SSM Parameter Store at runtime
# - No secrets in version control

- name: Configure NVIDIA HPC/AI Compute Infrastructure
  hosts: nvidia
  gather_facts: yes
  become: yes

  tasks:
    - name: Display node information
      ansible.builtin.debug:
        msg: |
          Configuring NVIDIA compute node: {{ inventory_hostname }}
          Cluster: {{ cluster_id }}
          IP Address: {{ ansible_host }}
          GPU Model: {{ nvidia_gpu_model }}

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install prerequisite packages
      ansible.builtin.apt:
        name:
          - build-essential
          - dkms
          - linux-headers-{{ ansible_kernel }}
          - pciutils
          - python3
          - python3-pip
        state: present

    - name: Add NVIDIA CUDA repository
      block:
        - name: Download CUDA repository package
          ansible.builtin.get_url:
            url: "https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.0-1_all.deb"
            dest: /tmp/cuda-keyring.deb

        - name: Install CUDA repository package
          ansible.builtin.apt:
            deb: /tmp/cuda-keyring.deb
            state: present

        - name: Update apt cache after adding CUDA repo
          ansible.builtin.apt:
            update_cache: yes

    - name: Install NVIDIA drivers
      ansible.builtin.apt:
        name: "{{ nvidia_driver_package }}"
        state: present
      register: driver_install
      notify: Reboot system

    - name: Install CUDA toolkit
      ansible.builtin.apt:
        name: "cuda-toolkit-{{ cuda_version | replace('.', '-') }}"
        state: present

    - name: Configure CUDA environment variables
      ansible.builtin.lineinfile:
        path: /etc/environment
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - { regexp: '^PATH=', line: 'PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/cuda/bin"' }
        - { regexp: '^LD_LIBRARY_PATH=', line: 'LD_LIBRARY_PATH="/usr/local/cuda/lib64"' }

    - name: Install NVIDIA Container Toolkit
      when: nvidia_container_toolkit_enabled | bool
      block:
        - name: Add NVIDIA Container Toolkit repository
          ansible.builtin.shell: |
            curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
            curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
              sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
              tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
          args:
            creates: /etc/apt/sources.list.d/nvidia-container-toolkit.list

        - name: Update apt cache
          ansible.builtin.apt:
            update_cache: yes

        - name: Install NVIDIA Container Toolkit
          ansible.builtin.apt:
            name: nvidia-container-toolkit
            state: present

        - name: Configure containerd for NVIDIA runtime
          ansible.builtin.shell: |
            nvidia-ctk runtime configure --runtime=containerd
          when: containerd_enabled | bool
          notify: Restart containerd

    - name: Install NVIDIA Data Center GPU Manager (DCGM)
      when: nvidia_dcgm_enabled | bool
      block:
        - name: Download DCGM
          ansible.builtin.get_url:
            url: "https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/datacenter-gpu-manager_3.1.8_amd64.deb"
            dest: /tmp/dcgm.deb

        - name: Install DCGM
          ansible.builtin.apt:
            deb: /tmp/dcgm.deb
            state: present

        - name: Start DCGM service
          ansible.builtin.systemd:
            name: nvidia-dcgm
            enabled: yes
            state: started

    - name: Install Fabric Manager
      when: nvidia_fabric_manager_enabled | bool
      block:
        - name: Install Fabric Manager package
          ansible.builtin.apt:
            name: "nvidia-fabricmanager-{{ nvidia_fabric_manager_version }}"
            state: present

        - name: Enable Fabric Manager service
          ansible.builtin.systemd:
            name: nvidia-fabricmanager
            enabled: yes
            state: started

    - name: Configure MIG mode
      when: nvidia_mig_enabled | bool
      block:
        - name: Enable MIG mode on GPUs
          ansible.builtin.command:
            cmd: nvidia-smi -mig 1
          register: mig_enable
          changed_when: "'Enabled MIG mode' in mig_enable.stdout"

        - name: Display MIG capability
          ansible.builtin.command:
            cmd: nvidia-smi --query-gpu=index,name,mig.mode.current --format=csv
          register: mig_status
          changed_when: false

        - name: Show MIG status
          ansible.builtin.debug:
            var: mig_status.stdout_lines

    - name: Configure InfiniBand/RDMA
      when: infiniband_enabled | bool
      block:
        - name: Install RDMA packages
          ansible.builtin.apt:
            name: "{{ rdma_core_packages }}"
            state: present

        - name: Load RDMA kernel modules
          ansible.builtin.modprobe:
            name: "{{ item }}"
            state: present
          loop:
            - ib_uverbs
            - ib_core
            - rdma_ucm

        - name: Start RDMA service
          ansible.builtin.systemd:
            name: rdma-core
            enabled: yes
            state: started

    - name: Install NCCL library
      block:
        - name: Install NCCL
          ansible.builtin.apt:
            name: "libnccl2"
            state: present

        - name: Configure NCCL environment variables
          ansible.builtin.lineinfile:
            path: /etc/environment
            regexp: "{{ item.regexp }}"
            line: "{{ item.line }}"
          loop:
            - { regexp: '^NCCL_DEBUG=', line: 'NCCL_DEBUG="{{ nccl_debug }}"' }
            - { regexp: '^NCCL_IB_DISABLE=', line: 'NCCL_IB_DISABLE="{{ nccl_ib_disable }}"' }
            - { regexp: '^NCCL_NET_GDR_LEVEL=', line: 'NCCL_NET_GDR_LEVEL="{{ nccl_net_gdr_level }}"' }

    - name: Configure system performance
      block:
        - name: Set CPU governor to performance
          ansible.builtin.shell: |
            echo {{ cpu_governor }} | tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
          changed_when: false

        - name: Configure hugepages
          when: hugepages_enabled | bool
          block:
            - name: Set hugepages count
              ansible.builtin.sysctl:
                name: vm.nr_hugepages
                value: "{{ hugepages_count }}"
                state: present
                reload: yes

        - name: Apply sysctl tuning
          ansible.builtin.sysctl:
            name: "{{ item.key }}"
            value: "{{ item.value }}"
            state: present
            reload: yes
          loop: "{{ sysctl_settings | dict2items }}"

    - name: Mount Weka filesystem
      when: weka_mount_enabled | bool
      block:
        - name: Create Weka mount point
          ansible.builtin.file:
            path: "{{ weka_mount_point }}"
            state: directory
            mode: '0755'

        - name: Install Weka client
          when: weka_client_type == 'native'
          block:
            - name: Download Weka client
              ansible.builtin.get_url:
                url: "https://{{ weka_nfs_server }}/dist/v1/install"
                dest: /tmp/weka-install.sh
                mode: '0755'

            - name: Install Weka client software
              ansible.builtin.command:
                cmd: bash /tmp/weka-install.sh
              register: weka_client_install
              changed_when: "'Successfully installed' in weka_client_install.stdout"

        - name: Mount Weka via NFS
          when: weka_client_type == 'nfs'
          ansible.builtin.mount:
            path: "{{ weka_mount_point }}"
            src: "{{ weka_nfs_server }}:{{ weka_nfs_export }}"
            fstype: nfs
            opts: "{{ weka_nfs_options }}"
            state: mounted

    - name: Install monitoring tools
      when: prometheus_node_exporter_enabled | bool
      block:
        - name: Install Prometheus node exporter
          ansible.builtin.apt:
            name: prometheus-node-exporter
            state: present

        - name: Start node exporter
          ansible.builtin.systemd:
            name: prometheus-node-exporter
            enabled: yes
            state: started

        - name: Install NVIDIA GPU exporter
          when: nvidia_gpu_exporter_enabled | bool
          block:
            - name: Download NVIDIA GPU Prometheus exporter
              ansible.builtin.get_url:
                url: "https://github.com/utkuozdemir/nvidia_gpu_exporter/releases/download/v1.2.0/nvidia_gpu_exporter_1.2.0_linux_amd64.tar.gz"
                dest: /tmp/nvidia_gpu_exporter.tar.gz

            - name: Extract GPU exporter
              ansible.builtin.unarchive:
                src: /tmp/nvidia_gpu_exporter.tar.gz
                dest: /usr/local/bin
                remote_src: yes
                creates: /usr/local/bin/nvidia_gpu_exporter

            - name: Create systemd service for GPU exporter
              ansible.builtin.copy:
                content: |
                  [Unit]
                  Description=NVIDIA GPU Prometheus Exporter
                  After=network.target

                  [Service]
                  Type=simple
                  ExecStart=/usr/local/bin/nvidia_gpu_exporter
                  Restart=always

                  [Install]
                  WantedBy=multi-user.target
                dest: /etc/systemd/system/nvidia-gpu-exporter.service
                mode: '0644'

            - name: Start GPU exporter
              ansible.builtin.systemd:
                name: nvidia-gpu-exporter
                enabled: yes
                state: started
                daemon_reload: yes

    - name: Verify GPU installation
      block:
        - name: Check NVIDIA driver version
          ansible.builtin.command:
            cmd: nvidia-smi --query-gpu=driver_version --format=csv,noheader
          register: driver_version
          changed_when: false

        - name: Display driver version
          ansible.builtin.debug:
            msg: "NVIDIA Driver Version: {{ driver_version.stdout }}"

        - name: Query GPU information
          ansible.builtin.command:
            cmd: nvidia-smi --query-gpu=index,name,memory.total,compute_mode --format=csv
          register: gpu_info
          changed_when: false

        - name: Display GPU information
          ansible.builtin.debug:
            var: gpu_info.stdout_lines

  handlers:
    - name: Reboot system
      ansible.builtin.reboot:
        msg: "Rebooting to apply NVIDIA driver changes"
        reboot_timeout: 600

    - name: Restart containerd
      ansible.builtin.systemd:
        name: containerd
        state: restarted
